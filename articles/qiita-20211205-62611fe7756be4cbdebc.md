* * *

title: "mlflowã¨luigiã«ã‚ˆã‚‹MLå®Ÿé¨“ç®¡ç†ä¾‹"
emoji: "ğŸ˜€"
type: "tech"
topics: [Python,Luigi,MLflow]

## published: true

# ã¯ã˜ã‚ã«

ã“ã®è¨˜äº‹ã¯[BrainPad Advent Calendar 2021](https://qiita.com/advent-calendar/2021/brainpad)ã®10æ—¥ç›®ã®è¨˜äº‹ã§ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯MLã®å®Ÿé¨“ã‚’è¡Œã†ã¨ãã®ã€ã‚³ãƒ¼ãƒ‰ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ãƒ¢ãƒ‡ãƒ«ã€è©•ä¾¡çµæœã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã®æ§‹æˆä¾‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
[ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã¯ã“ã¡ã‚‰](https://github.com/mina-moto/ml_experiment_management_demo)

# å‰æçŸ¥è­˜

- Must
  - python
  - docker
- Want
  - mlflow
  - luigi

# æ€æƒ³

- å‰å‡¦ç†ã‚’åŠ ãˆãŸãƒ‡ãƒ¼ã‚¿ã‚„å­¦ç¿’ã—ãŸãƒ¢ãƒ‡ãƒ«ãªã©ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã§å‡ºåŠ›ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯å…¨ã¦mlflowã®ç®¡ç†ä¸‹ã«ãŠãã€‚
- ã‚³ãƒ¼ãƒ‰ã¯gitã§ç®¡ç†ã—ã€å®Ÿé¨“çµæœã¨commit hashã‚’ç´ã¥ã‘ã‚‹ã€‚
- å‰å‡¦ç†ã€å­¦ç¿’ã€æ¨è«–ãªã©ã‚¿ã‚¹ã‚¯åŒå£«ã®ä¾å­˜é–¢ä¿‚ã‚’ç®¡ç†ã—ã¦ã€ä¾å­˜ã—ã¦ã„ã‚‹ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•ã§å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚ã¾ãŸã€æ—¢ã«å®Ÿè¡Œã•ã‚ŒãŸã‚¿ã‚¹ã‚¯ã¯å®Ÿè¡Œã—ãªã„ã‚ˆã†ã«ã™ã‚‹ã€‚

# æ§‹æˆæ¦‚è¦

- [titanicã®data](https://www.kaggle.com/c/titanic/data)ã«å¯¾ã—ã¦ã€å‰å‡¦ç†ã€å­¦ç¿’ã€æ¨è«–ã‚’è¡Œã†ä¾‹ã‚’ç´¹ä»‹ã™ã‚‹ã€‚
- ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã®ã‚ˆã†ãªæ„Ÿã˜ã€‚
- `src/tasks/`ä¸‹ã«å‰å‡¦ç†ãªã©ã®å…·ä½“çš„ãªã‚¿ã‚¹ã‚¯ã‚’è¡Œã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã™ã‚‹ã€‚
- tomlãƒ•ã‚¡ã‚¤ãƒ«ã§å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã‚’æŒ‡å®šã—ã¦`src/runner.py`ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
- å„ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›ã¯ã€mlrunsä¸‹ã®mlflowã®å‡ºåŠ›ãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†å…ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆä½ç½®ã«å®Ÿé¨“ã”ã¨ã«å‡ºåŠ›ã™ã‚‹ã€‚

```:ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ
.
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ LICENSE
â”œâ”€â”€ README.md
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ input
â”‚Â Â  â”œâ”€â”€ gender_submission.csv
â”‚Â Â  â”œâ”€â”€ test.csv
â”‚Â Â  â”œâ”€â”€ titanic.zip
â”‚Â Â  â””â”€â”€ train.csv
â”œâ”€â”€ luigi.toml
â”œâ”€â”€ mlruns/
â”œâ”€â”€ requirements.txt
â””â”€â”€ src
    â”œâ”€â”€ runner.py
    â””â”€â”€ tasks
        â”œâ”€â”€ prediction.py
        â”œâ”€â”€ preprocessor.py
        â”œâ”€â”€ run_task.py
        â””â”€â”€ trainer.py
```

# ç’°å¢ƒæ§‹ç¯‰

- mlflowãªã©å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å…¥ã‚Œã‚‹Dockerfileã‚’é©å½“ã«ä½œæˆã—ã¦ã€ä¸‹è¨˜ã®ã‚ˆã†ãªdocker-compose.ymlã‚’ç”¨æ„ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã§`docker-compose up d`ãªã©ã§mlflow trackingã‚µãƒ¼ãƒã‚’ç«‹ã¡ä¸Šã’ã‚‹ã€‚
- mlflow trackingã§ã¯ã€ã‚µãƒ¼ãƒã‚’ç«‹ã¡ä¸Šã’ã‚‹ã¨ãã«metricãªã©ã‚’ç®¡ç†ã™ã‚‹Tracking URIã¨ã€å‡ºåŠ›ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã™ã‚‹Artifact URIã¨ã„ã†2ã¤ã®URIã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã©ã¡ã‚‰ã‚‚./mlruns/ä¸‹ã«ä¿å­˜ã•ã‚Œã‚‹ã€‚
- ã‚µãƒ¼ãƒã‚’ç«‹ã¡ä¸Šã’ãŸå¾Œ`{ã‚µãƒ¼ãƒã®IP}:{æŒ‡å®šã—ãŸãƒãƒ¼ãƒˆç•ªå·}`ã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã“ã¨ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã€‚

```docker-compose.yml
version: "3"
services:
  mlflow:
    image: ml_experiment_management_demo
    container_name: ml_experiment_management_demo_mlflow
    build:
      context: .
      dockerfile: Dockerfile
    volumes:
      - $PWD:$PWD
    working_dir: $PWD
    ports:
      - "5000:5000"
    command: mlflow ui -h 0.0.0.0
    restart: always
```

# ã‚³ãƒ¼ãƒ‰ã®æ§‹æˆ

.envã«ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹ã€åˆ©ç”¨ã™ã‚‹configã®ãƒ‘ã‚¹ã€configã®ç¨®é¡ã‚’æŒ‡å®šã™ã‚‹ã€‚

```:.env
PROJECT_ROOT={ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‘ã‚¹ã‚’æŒ‡å®š}
LUIGI_CONFIG_PATH=luigi.toml
LUIGI_CONFIG_PARSER=toml
```

- luigiã®æ©Ÿèƒ½ã§ç’°å¢ƒå¤‰æ•°LUIGI_CONFIG_PATHã«æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’configã¨ã—ã¦èª­ã¿è¾¼ã‚€ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã“ã§ã¯luigi.tomlã¨ã—ã¦ã„ã‚‹ã€‚
- RunConfigã¯`runner.py`ã§åˆ©ç”¨ã™ã‚‹configã§ã€å®Ÿé¨“åã‚„æ¦‚è¦ã€å®Ÿè¡Œã™ã‚‹taskã‚’æŒ‡å®šã™ã‚‹è¨­è¨ˆã«ãªã£ã¦ã„ã‚‹ã€‚
- PathConfigã§ã¯å„ã‚¿ã‚¹ã‚¯ã®å…¥å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®pathã‚’å®šç¾©ã™ã‚‹ã€‚
- å‰å‡¦ç†ã€å­¦ç¿’ã€æ¨è«–ã®å„ã‚¿ã‚¹ã‚¯ã®configã¯Preprocessorã€Trainerã€Predictionã«å®šç¾©ã™ã‚‹ã€‚

```luigi.toml
[RunConfig]
#å®Ÿé¨“å:mlflowã®å®Ÿé¨“å˜ä½
experiment_name="demo"
description="æ¦‚è¦"
# å®Ÿè¡Œã™ã‚‹Task
task="Prediction"

[PathConfig]
# input
input="./input/"

# Preprocessorã®outputã€Trainerã€Evaluatorã®input
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯artifact_uriä¸‹ã€"./mlruns/{experiment_id}/{run_id}/artifacts/preprocessor/"ã¨ãªã‚‹ã€‚
#preprocessor="./mlruns/"

# Trainerã®outputã€Evaluatorã®input
# ãƒ‡ãƒ•ã‚©ãƒ«ã¯ãƒˆartifact_uriä¸‹"./mlruns/{experiment_id}/{run_id}/artifacts/trainer/"ã¨ãªã‚‹ã€‚
#trainer="./mlruns/"

# Predictionã®outputã€
# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯artifact_uriä¸‹"./mlruns/{experiment_id}/{run_id}/artifacts/prediction/"ã¨ãªã‚‹ã€‚
#trainer="./mlruns/"

[Preprocessor]
train_columns=['PassengerId','Survived', 'Pclass', 'SibSp', 'Parch']
test_columns=['PassengerId','Pclass', 'SibSp', 'Parch']

[Trainer]
seed=0

[Prediction]

```

- `runner.py`ãŒå®Ÿéš›ã«å®Ÿè¡Œã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã«ãªã‚‹ã€‚
- .envã¨RunConfigã‚’èª­ã¿è¾¼ã‚“ã§æŒ‡å®šã—ãŸtaskã‚’å®Ÿè¡Œã™ã‚‹ã€‚
- experiment_nameã‚’å®Ÿé¨“åã¨ã—ã¦è¨­å®šã—ã¦ã€åˆ©ç”¨ã—ãŸconfigãƒ•ã‚¡ã‚¤ãƒ«ã‚„å®Ÿè¡Œã™ã‚‹taskã‚’logã¨ã—ã¦è¨˜éŒ²ã—ã¦ã„ã‚‹ã€‚è©³ã—ãã¯[mlflow trackingã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.mlflow.org/docs/latest/tracking.html#)å‚ç…§ã€‚

```python:runner.py
import os
import sys

import luigi
import mlflow
from dotenv import load_dotenv
from luigi.configuration import add_config_path, get_config

from tasks.prediction import Prediction
from tasks.preprocessor import Preprocessor
from tasks.trainer import Trainer


def main():
    load_dotenv()
    sys.path.append(f"{os.getenv('PROJECT_ROOT')}src/")
    add_config_path(os.getenv("LUIGI_CONFIG_PATH"))
    run_config = get_config(os.getenv("LUIGI_CONFIG_PARSER"))["RunConfig"]
    mlflow.set_experiment(run_config["experiment_name"])
    mlflow.start_run()
    mlflow.set_tag('mlflow.note.content', run_config["description"])
    mlflow.log_param("description", run_config["description"])
    mlflow.log_param("task", run_config["task"])
    mlflow.set_tag('mlflow.runName', mlflow.active_run().info.run_id)
    mlflow.log_artifact(os.getenv("LUIGI_CONFIG_PATH"))
    luigi.run([run_config["task"], "--local-scheduler"])
    mlflow.end_run()


if __name__ == '__main__':
    main()
```

## ã‚¿ã‚¹ã‚¯ã®å®šç¾©

- `runner.py`ã§å®Ÿè¡Œã™ã‚‹ã‚¿ã‚¹ã‚¯ã¯RunTaskã‚¯ãƒ©ã‚¹ã‚’ç¶™æ‰¿ã—ã¦ä½œæˆã™ã‚‹ã€‚
- RunTaskã‚¯ãƒ©ã‚¹ã§ã¯ã€PathConfigã§å„ã‚¿ã‚¹ã‚¯ã®å‡ºåŠ›å…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®pathãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã—ã€æŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆ`./mlruns/{experiment_id}/{run_id}/artifacts/{task_name}/`ã«è¨­å®šã™ã‚‹ã€‚
- build_input_output_path_dictsã¯ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§å…¥å‡ºåŠ›pathã®ä¸€è¦§ã‚’è¿”ã™ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦ãŠã‚Šã€ã‚µãƒ–ã‚¯ãƒ©ã‚¹ã§ã¯è¨­å®šã•ã‚ŒãŸpath_configã‚’ç”¨ã„ã¦ã€å…¥å‡ºåŠ›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‹ã‚‰ã®ç›¸å¯¾ãƒ‘ã‚¹ã‹çµ¶å¯¾ãƒ‘ã‚¹ã‚’è¿”ã™ã‚ˆã†ã«å®Ÿè£…ã™ã‚‹ã€‚
- RunTaskã‚¯ãƒ©ã‚¹ã¯luigiã®Taskã‚’ç¶™æ‰¿ã—ã¦ãŠã‚Šã€outputãƒ¡ã‚½ãƒƒãƒ‰ã§output_paths_dictã®å€¤ã‚’luigiã®LocalTargetã¨ã—ã¦æŒ‡å®šã™ã‚‹ã€‚
- luigi.Taskã®æ©Ÿèƒ½ã§ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å®Ÿè¡Œå¾Œoutputãƒ¡ã‚½ãƒƒãƒ‰ã§æŒ‡å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«ã‚ã‚‹å ´åˆã€å®Ÿè¡Œæ¸ˆã®ã‚¿ã‚¹ã‚¯ã¨è¦‹ãªã•ã‚Œã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€RunTaskã‚’ç¶™æ‰¿ã—ãŸå„ã‚¿ã‚¹ã‚¯ã¯output_paths_dictã«è¨­å®šã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«ã‚ã‚Œã°ã€å®Ÿè¡Œã—ãªãã¦æ¸ˆã‚€ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚
- ã¾ãŸã€PathConfigã‚’æŒ‡å®šã—ãªã‹ã£ãŸå ´åˆã€run_idã¯æ¯å›å¤‰ã‚ã‚‹ã®ã§ãã®ã‚¿ã‚¹ã‚¯ã¯å¿…ãšå®Ÿè¡Œã•ã‚Œã‚‹ã€‚

```python:run_task.py
import os
from abc import abstractmethod
from typing import Tuple

import luigi
import mlflow
from luigi.configuration import get_config


class RunTask(luigi.Task):
    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)
        self.config = get_config(
            os.getenv("LUIGI_CONFIG_PARSER")
        )[self.__class__.__name__]

        experiment_id = mlflow.active_run().info.experiment_id
        run_id = mlflow.active_run().info.run_id

        self.path_config = get_config(
            os.getenv("LUIGI_CONFIG_PARSER"))["PathConfig"]
        self.artifacts_uri_path = f"./mlruns/{experiment_id}/{run_id}/artifacts/"

        # ã‚¿ã‚¹ã‚¯ã”ã¨ã«PathConfigãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®š
        # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ ./mlruns/{experiment_id}/{run_id}/artifacts/{task_name}/
        configs_keys = get_config(os.getenv("LUIGI_CONFIG_PARSER")).data.keys()
        task_list = [i for i in configs_keys if i not in [
            "RunConfig", 'PathConfig']]
        for task_name in task_list:
            self.path_config.setdefault(
                task_name,
                f"{self.artifacts_uri_path}{task_name}/")
        # å…¥å‡ºåŠ›ãƒ‘ã‚¹ output_paths_dictã®valuesã®ãƒ‘ã‚¹ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ—¢ã«ã‚ã‚‹å ´åˆã€ãã®ã‚¿ã‚¹ã‚¯ã¯è¡Œã‚ã‚Œãªã„
        self.input_paths_dict, self.output_paths_dict = self.build_input_output_path_dicts()
        for output_path in self.output_paths_dict.values():
            os.makedirs(os.path.dirname(output_path), exist_ok=True)

    @abstractmethod
    def build_input_output_path_dicts(self) -> Tuple[dict, dict]:
        """
        ã‚¯ãƒ©ã‚¹ã®å…¥å‡ºåŠ›ãƒ‘ã‚¹ã‚’ãã‚Œãã‚Œdictã§è¿”ã™

        Returns:
            input_paths_dict,output_paths_dict
        """
        pass

    def output(self):
        return list(map(lambda x: luigi.LocalTarget(x),
                        self.output_paths_dict.values()))
```

### å‰å‡¦ç†

- RunTaskã®èª¬æ˜ã§è¿°ã¹ãŸã‚ˆã†ã«ã€å‰å‡¦ç†ã®ã‚¿ã‚¹ã‚¯Preprocessorã‚¯ãƒ©ã‚¹ã¯RunTaskã‚’ç¶™æ‰¿ã—ã¦ä½œæˆã™ã‚‹ã€‚
- build_input_output_path_dictsã§path_configã®å€¤ã‚’åˆ©ç”¨ã—ã¦ã€å…¥å‡ºåŠ›pathã‚’è¨­å®šã—ã¦ã„ã‚‹ã€‚
- runãƒ¡ã‚½ãƒƒãƒ‰ãŒtaskã®å®Ÿè¡Œã™ã‚‹å‡¦ç†ã§ã€ã“ã“ã§ã¯å‰å‡¦ç†ã®å†…å®¹ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã€‚
- ã“ã“ã§è¡Œã£ã¦ã„ã‚‹å‰å‡¦ç†ã¯ã€ã‚·ãƒ³ãƒ—ãƒ«ã«trainã€testã‚’configã§æŒ‡å®šã—ãŸcolumnsã®ã¿ã«ã—ã¦ã„ã‚‹ã ã‘ã§ã‚ã‚‹ã€‚

```python:preprocessor.py
from typing import Tuple

import pandas as pd

from tasks.run_task import RunTask


class Preprocessor(RunTask):
    def build_input_output_path_dicts(self) -> Tuple[dict, dict]:
        input_paths_dict = {
            "train": f"{self.path_config['input']}train.csv",
            "test": f"{self.path_config['input']}test.csv",
        }
        output_paths_dict = {
            "train": f"{self.path_config['Preprocessor']}train.csv",
            "test": f"{self.path_config['Preprocessor']}test.csv",
        }
        return input_paths_dict, output_paths_dict

    def run(self):
        train = pd.read_csv(self.input_paths_dict["train"])
        test = pd.read_csv(self.input_paths_dict["test"])
        train = train[self.config["train_columns"]]
        test = test[self.config["test_columns"]]
        train.to_csv(self.output_paths_dict["train"], index=False)
        test.to_csv(self.output_paths_dict["test"], index=False)
```

### å­¦ç¿’

- å‰å‡¦ç†ã¨åŒæ§˜ã«RunTaskã‚’ç¶™æ‰¿ã—ã¦ä½œæˆã—ã¦ã„ã‚‹ã€‚
- luigiã®æ©Ÿèƒ½ã®`@requires`ã¸ãƒ«ãƒ‘ã‚’ç”¨ã„ã¦ã€Preprocessorã«ä¾å­˜ã—ã¦ã„ã‚‹ã“ã¨ã‚’å®šç¾©ã—ã¦ã„ã‚‹ã€‚ã“ã‚Œã«ã‚ˆã‚ŠTrainerã‚’å®Ÿè¡Œã™ã‚‹å‰ã«PreprocessorãŒå…ˆã«å®Ÿè¡Œã•ã‚Œã‚‹ã€‚è©³ã—ãã¯[luigiã®document](https://luigi.readthedocs.io/en/stable/api/luigi.util.html#using-inherits-and-requires-to-ease-parameter-pain)å‚ç…§ã€‚
- ã¾ãŸã€Trainerã§ã¯sklearnã®ãƒ¢ãƒ‡ãƒ«ã§å­¦ç¿’ã—ã¦ã„ã‚‹ãŒã€mlflowã®`mlflow.sklearn.autolog`ã‚’ç”¨ã„ã‚‹ã“ã¨ã§ã€Metricsãªã©ãŒã„ãã¤ã‹è‡ªå‹•ã§ä¿å­˜ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚è‡ªåˆ†ã§æŒ‡æ¨™ã‚’è¨­å®šã—ãŸã„ã¨ãã¯`log_metric`ãªã©ã‚’ç”¨ã„ã‚‹ã€‚è©³ã—ãã¯[mlflowã®Logging Functionsã®document](https://www.mlflow.org/docs/latest/tracking.html#logging-functions)å‚ç…§ã€‚

```python:trainer.py
import pickle
from typing import Tuple

import mlflow.sklearn
import pandas as pd
from luigi.util import requires
from sklearn import linear_model

from tasks.preprocessor import Preprocessor
from tasks.run_task import RunTask


@requires(Preprocessor)
import pickle
from typing import Tuple

import mlflow.sklearn
import pandas as pd
from luigi.util import requires
from sklearn import linear_model

from tasks.preprocessor import Preprocessor
from tasks.run_task import RunTask


@requires(Preprocessor)
class Trainer(RunTask):
    def build_input_output_path_dicts(self) -> Tuple[dict, dict]:
        input_paths_dict = {
            "train": f"{self.path_config['Preprocessor']}train.csv",
            "test": f"{self.path_config['Preprocessor']}test.csv",
        }
        output_paths_dict = {
            "model": f"{self.path_config['Trainer']}model",
        }
        return input_paths_dict, output_paths_dict

    def run(self):
        train = pd.read_csv(
            self.input_paths_dict["train"],
            index_col='PassengerId')
        X = train.drop("Survived", axis=1)
        y = train["Survived"]
        mlflow.sklearn.autolog()
        reg = linear_model.RidgeClassifier(random_state=self.config["seed"])
        reg.fit(X, y)
        pickle.dump(reg, open(self.output_paths_dict["model"], "wb"))
```

### æ¨è«–

- å‰å‡¦ç†ãƒ»å­¦ç¿’ã¨åŒæ§˜ã«RunTaskã‚’ç¶™æ‰¿ã—ã¦ä½œæˆã™ã‚‹ã€‚
- å®Ÿè¡Œã«å‰å‡¦ç†æ¸ˆã¿ã®testã¨å­¦ç¿’ã—ãŸmodelãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€Preprocessor, Trainerã‚’`@requires`ã«æŒ‡å®šã—ã¦ã„ã‚‹ã€‚

```python:prediction.py
import pickle
from typing import Tuple

import pandas as pd
from luigi.util import requires

from tasks.preprocessor import Preprocessor
from tasks.run_task import RunTask
from tasks.trainer import Trainer


@requires(Preprocessor, Trainer)
class Prediction(RunTask):
    def build_input_output_path_dicts(self) -> Tuple[dict, dict]:
        input_paths_dict = {
            "test": f"{self.path_config['Preprocessor']}test.csv",
            "model": f"{self.path_config['Trainer']}model",
        }
        output_paths_dict = {
            "test_prediction": f"{self.path_config['Prediction']}test_prediction.csv", }
        return input_paths_dict, output_paths_dict

    def run(self):
        test = pd.read_csv(
            self.input_paths_dict["test"],
            index_col="PassengerId")
        model = pickle.load(open(self.input_paths_dict["model"], "rb"))
        test_prediction = pd.DataFrame(
            model.predict(test),
            columns=["Survived"],
            index=test.index
        )
        test_prediction.to_csv(self.output_paths_dict["test_prediction"])

```

# å®Ÿè¡Œä¾‹

- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã§`python src/runnr.py`ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§ã€configã®taskã§æŒ‡å®šã—ãŸã‚¿ã‚¹ã‚¯ã‚’å®Ÿè¡Œã™ã‚‹ã€‚ä¾‹ãˆã°`task="Prediction"`ã¨ã—ã¦ã„ã‚Œã°ã€Predictionã®runã‚’å®Ÿè¡Œã™ã‚‹ã€‚ãŸã ã—ã€Predictionã¯Preprocessor,Trainerã«ä¾å­˜ã—ã¦ã„ã‚‹ãŸã‚ã€å…ˆã«å‰å‡¦ç†ã€å­¦ç¿’ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã€‚
- ä¸Šè¨˜ã®å®Ÿè¡Œå¾Œã€ä¸‹è¨˜ã®ã‚ˆã†ã«Preprocessor,Trainerã®pathã‚’å„ã‚¿ã‚¹ã‚¯ã®å®Ÿè¡Œçµæœã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æŒ‡å®šã—ã¦ã€å†ã³`task="Prediction"`ã¨ã—ã¦å®Ÿè¡Œã—ãŸå ´åˆã€Predictionã®å…¥åŠ›ã¨ã—ã¦å…ˆç¨‹ã®å®Ÿè¡ŒçµæœãŒç”¨ã„ã‚‰ã‚Œã‚‹ã€‚ã“ã®å ´åˆã€å‰å‡¦ç†ã€å­¦ç¿’ã®å‡¦ç†ã¯çœç•¥ã§ãã‚‹ã€‚

```toml:
[PathConfig]
Preprocessor="./mlruns/1/ba79349b64ac4493ac1f6c6eac306e68/artifacts/Preprocessor/"
Trainer="./mlruns/1/ba79349b64ac4493ac1f6c6eac306e68/artifacts/Trainer/"
```

# èª²é¡Œ

- mlflowã®artifact URIãŒãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‰æã§ã€ã‚³ãƒ¼ãƒ‰å†…ã§ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦ã„ã‚‹ã€‚ã¤ã¾ã‚Šã€å®Ÿè¡Œã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆç›´ä¸‹ã®mlruns/ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä¸‹ã§ç®¡ç†ã™ã‚‹å‰æã«ãªã£ã¦ã„ã‚‹ã€‚ç’°å¢ƒå¤‰æ•°ã‚„configãƒ•ã‚¡ã‚¤ãƒ«ãªã©ã§æŒ‡å®šã§ãã‚‹ã‚ˆã†ã«ã—ãŸã»ã†ãŒæœ›ã¾ã—ã„ã€‚
- 1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å…¨ã¦ã®configã‚’ã¾ã¨ã‚ã¦ã„ã‚‹ã®ã§ã€è¨­å®šé …ç›®ãŒå¤šããªã‚‹ã¨é »é›‘ã«ãªã‚‹ã€‚ãŸã ã—ã€åŠç«¯ã«åˆ†ã‘ã¦ã‚‚æ‰±ã„ã¥ã‚‰ããªã‚‹ã¨æ€ã†ã®ã§é›£ã—ã„ã¨ã“ã‚ã€‚
